from transformers.models.gpt2.modeling_gpt2 import GPT2Model
from transformers import BertTokenizer, BertModel
from einops import rearrange
from transformers.models.gpt2.configuration_gpt2 import GPT2Config
from transformers import AutoTokenizer
import torch
import pandas as pd
gpt2 = GPT2Model.from_pretrained('gpt2', output_attentions=True, output_hidden_states=True)
tokenizer = AutoTokenizer.from_pretrained('gpt2')
data_name = 'NP'
exogenous_variables = ['Grid Load','Wind Power']
endogenous_variable = 'Nord Pool Electricity Price'
data_collection = 'Nord Pool electricity market'
exogenous_variables_text_template = 'Exogenous'
endogenous_template = 'Endogenous'
dataset_template1 = f'This dataset is {data_name}, containing the data collected from {data_collection}. Exogenous variables are'
dataset_template2 = f' and it is necessary to utilize these external variables sequentially to predict the endogenous variable'
trend_template = ['series shows an overall upward trend',
                  'series initially rises and then declines',
                  'series exhibits an overall declining trend',
                  'series initially declines and then rises']
period_template = ['series has no apparent periodicity',
                   'series exhibits shorter periodicity and higher frequency',
                   'series displays clear periodicity',
                   'series exhibits relatively longer periodicity']
stability_template = ['series undergoes significant instability over all the time',
                      'series remains relatively stable with minimal fluctuations',
                      'series experiences occasional bouts of volatility, interspersed with periods of relative calm',
                      'series shows consistent stability, with values remaining close to a steady mean']
noise_template = ['series is subject to very strong noise interference',
                  'series has a low signal-to-noise ratio, where noise significantly affects the clarity of the underlying data',
                  'series experiences moderate noise, partially obscuring the underlying pattern',
                  'series is not influenced by any noise interference']

nature_attribute_template = {
    'Grid Load': [
        'This Exogenous variable is Grid Load, which represents the overall electricity demand in the grid. The grid load can be influenced by various external factors such as time of day, weather conditions, and seasonal variations. It is often correlated with electricity prices and supply conditions, as higher grid loads typically lead to increased demand for electricity.',
        'Exogenous Grid Load captures the total electricity consumption within the network. Changes in grid load can have a direct impact on the market prices and supply-demand balance, influencing how electricity prices are set at different times.',
        'Exogenous Grid Load reflects the electricity demand from the grid, where fluctuations in load often lead to changes in electricity prices. High grid loads may indicate stress on the electricity infrastructure, causing price hikes or scarcity in supply.',
        'Exogenous Grid Load indicates the total load on the electricity grid, which can influence electricity price dynamics. A surge in grid load may result in price increases, while lower loads may correlate with price reductions, reflecting the balance of supply and demand in the market.'
    ],
    'Wind Power': [
        'This Exogenous variable is Wind Power, representing the amount of electricity generated by wind energy sources. Wind power is highly variable, influenced by factors such as wind speed, location, and time of year. It can have a significant impact on electricity prices, particularly during times of high generation when prices may drop.',
        'Exogenous Wind Power captures the contribution of wind energy to the overall electricity supply. Wind generation is intermittent and its variability can cause fluctuations in market prices, especially during periods of high wind power generation or low demand.',
        'Exogenous Wind Power describes the electricity generated from wind energy. The availability of wind power can reduce the reliance on conventional power plants, lowering grid costs and influencing the overall electricity price, particularly during high generation periods.',
        'Exogenous Wind Power reflects the amount of electricity produced by wind farms. Its contribution to the grid supply can cause fluctuations in electricity prices, as abundant wind energy may lead to price drops, while a lack of wind can result in price increases.'
    ],
    'Nord Pool Electricity Price': [
        'This Endogenous variable is Nord Pool Electricity Price, which represents the market price of electricity on the Nord Pool market. The price is influenced by factors such as grid load, wind power generation, and overall market conditions. It fluctuates in response to changes in supply and demand dynamics.',
        'Endogenous Nord Pool Electricity Price reflects the market price of electricity on the Nord Pool exchange, driven by the supply-demand balance, grid load, and the availability of renewable energy sources like wind power. As grid load increases or wind power decreases, the price may rise.',
        'Endogenous Nord Pool Electricity Price represents the price of electricity traded on the Nord Pool market. This price is directly influenced by grid load and wind power levels, as fluctuations in either factor can lead to significant price changes within the market.',
        'Endogenous Nord Pool Electricity Price reflects the price of electricity in the Nord Pool market, which is determined by the supply and demand of electricity, including factors like grid load and wind power generation. The price typically rises during high demand or when renewable energy production is low.'
    ]
}
prompts = []
for v in exogenous_variables:
    for nature_attribute in nature_attribute_template[v]:
        prompts.append(nature_attribute)
    for trend in trend_template:
        prompts.append(exogenous_variables_text_template+' '+ v+' '+ trend + '.')
    for period in period_template:
        prompts.append(exogenous_variables_text_template+' '+ v+' '+ period + '.')
    for stability in stability_template:
        prompts.append(exogenous_variables_text_template+' '+ v+' '+ stability + '.')
    for noise in noise_template:
        prompts.append(exogenous_variables_text_template+' '+ v+' '+ noise + '.')

    dataset_template1 = dataset_template1+' '+v+','
for nature_attribute in nature_attribute_template[endogenous_variable]:
    prompts.append(nature_attribute)
for trend in trend_template:
    prompts.append(endogenous_template+' '+ endogenous_variable+' '+ trend + '.')
for period in period_template:
    prompts.append(endogenous_template+' '+ endogenous_variable+' '+ period + '.')
for stability in stability_template:
    prompts.append(endogenous_template+' '+ endogenous_variable+' '+ stability + '.')
for noise in noise_template:
    prompts.append(endogenous_template+' '+ endogenous_variable+' '+ noise + '.')

dataset_template2 = dataset_template2 + ' ' +  endogenous_variable+ '.'
dataset_template1 = dataset_template1 + dataset_template2
prompts.append(dataset_template1)
text_emds = []
eos_token = "<|endoftext|>" 
for p in prompts:
    prompts_with_eos = p + eos_token
    tokens = tokenizer(prompts_with_eos, padding=False, truncation=True, return_tensors="pt")
    input_ids = tokens["input_ids"]
    with torch.no_grad():
        outputs = gpt2(input_ids=input_ids)
    text_emds.append(outputs.last_hidden_state[:,-1])
text_emds = torch.cat(text_emds,dim=0)
torch.save(text_emds, data_name+'.pt')